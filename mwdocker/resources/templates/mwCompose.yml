# MediaWiki with MariaDB
# 
# This file was generated by pymediawikidocker {{pmwdVersion}} at {{timestamp}}
# see http://wiki.bitplan.com/index.php/Pymediawikidocker
#
# Access via "http://localhost:{{port}}"
#   (or "http://docker-machine ip:{{port}}" if using docker-machine)

services:

  # MySQL compatible relational database
  db:
    image: "mariadb:{{mariaDBVersion}}"
    container_name: "{{container_base_name}}-db"
    restart: always
    environment:
      MYSQL_DATABASE: "{{wiki_id}}_wiki"
      MYSQL_USER: "{{wiki_id}}_user"
      MYSQL_PASSWORD: "{{mySQLPassword}}"
      MYSQL_ROOT_PASSWORD: "{{mySQLRootPassword}}"
      # https://stackoverflow.com/a/67006851/1497139
      MYSQL_ROOT_HOST: "%"
    ports:
      - {{sql_port}}:3306
    volumes:
      - type: {{volume_type}}           # 'volume' or 'bind'
        source: {{mysql_data}}          # volume name or host path
        target: /var/lib/mysql          # container path

  # MediaWiki
  mw:
    container_name: {{container_base_name}}-mw
    user: "{{uid}}:{{gid}}"
    build: .
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    ports:
      - {{port}}:80
    links:
      - db
    depends_on:
      - db
    volumes:
      - type:   {{volume_type}}           # 'volume' or 'bind'
        source: {{wiki_sites}}            # volume name or host path
        target: /var/www/mediawiki/sites  # container path
    # docker managed volume
      - type: volume 
        source: wiki-etc                  # volume name 
        target: /etc                      # container path
      - type: volume 
        source: wiki-html                 # volume name 
        target: /var/www/html             # container path
    # host bound volumes
      - type: bind
        source: {{scripts_dir}}           # scripts directory path
        target: /scripts                  # container path

volumes:
  wiki-etc:
    driver: local
  wiki-html:
    driver: local
{% if volume_type == "volume" %}
  {{mysql_data}}:
    driver: local
  {{wiki_sites}}:
    driver: local
{% endif %}
