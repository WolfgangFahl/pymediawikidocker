#
# This dockerfile was generated by pymediawikidocker at {{timestamp}}
# see http://wiki.bitplan.com/index.php/Pymediawikidocker
#
FROM mediawiki:{{mwVersion}}

MAINTAINER Wolfgang Fahl <wf@bitplan.com>

# install some more utilities
RUN apt-get -y update && \
    apt-get -y --no-install-recommends --fix-missing install \
    mariadb-client \
    inetutils-ping \
    curl \
    git \
    graphviz \
    imagemagick \
    ssh-client \
    vim \
    unzip \
    libzip-dev \
    zip \
    && docker-php-ext-install zip \
    && rm -rf /var/lib/apt/lists/*

#  openssh-server \
#  dialog \
#  imagemagick \
#  graphviz \
#  libjpeg62-turbo-dev \
#  libfreetype6-dev \
#  libpng-dev \
#  libzip-dev \
#  docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
#  docker-php-ext-install gd

# install composer
RUN curl -sS https://getcomposer.org/installer | php \
    && mv composer.phar /usr/local/bin/composer
    
# make sure stick to version 1 of composer
RUN composer self-update --1

# update mediawiki extensions via composer
COPY composer.local.json /var/www/html

RUN composer update --no-dev

# copy the LocalSettings
COPY LocalSettings.php /var/www/html

# copy phpinfo.php
COPY phpinfo.php /var/www/html

# copy the SQL dump
COPY wiki.sql /tmp

# copy the initdb.sh script
COPY initdb.sh /tmp

# copy the installExtensions.sh script
COPY installExtensions.sh /tmp

# disable hostkey checking to enable non interactive git ssh checkout
RUN echo "StrictHostKeyChecking no" >> /etc/ssh_config

# copy the update.sh script
COPY update.sh /tmp

# copy the addSysopUser.sh script
COPY addSysopUser.sh /tmp

# make the scripts executable
RUN chmod +x /tmp/initdb.sh /tmp/update.sh /tmp/addSysopUser.sh /tmp/installExtensions.sh

# restore the mediawiki initial database backup
# can not do this before SQL server is up see https://docs.docker.com/compose/startup-order/
# RUN /tmp/initdb.sh


