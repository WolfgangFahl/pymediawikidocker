#
# This dockerfile was generated by pymediawikidocker {{pmwdVersion}} at {{timestamp}}
# see http://wiki.bitplan.com/index.php/Pymediawikidocker
#
FROM mediawiki:{{mwVersion}}

LABEL maintainer="Wolfgang Fahl <wf@bitplan.com>"

# we start as root user
# install some more utilities
# including gd
RUN apt-get -y update && \
    apt-get -y --no-install-recommends --fix-missing install \
    mariadb-client \
    inetutils-ping \
    cron \
    curl \
    git \
    graphviz \
    imagemagick \
    python3 \
    python3-pip \
    procps \
    rcs \
    ssh-client \
    sudo \
    vim \
    unzip \
    libzip-dev \
    zip \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    && docker-php-ext-install zip \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd \
    && rm -rf /var/lib/apt/lists/*

# install composer

# make sure to use version 2 instead of composer
# even if {{composerVersion}} is default
# https://blog.packagist.com/deprecating-composer-1-support/
# single layer two part
RUN curl -sS https://getcomposer.org/installer | php \
    && mv composer.phar /usr/local/bin/composer \
    && composer self-update --2

# fix ownership for MediaWiki directories
RUN chown -R www-data:www-data /var/www/html/images \
    && chown -R www-data:www-data /var/www/html/cache || true

# --- switch to runtime user ---
# make sure we can still use sudo
RUN echo "www-data ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/www-data && \
    chmod 440 /etc/sudoers.d/www-data
USER www-data