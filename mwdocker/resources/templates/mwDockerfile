#
# This dockerfile was generated by pymediawikidocker at {{timestamp}}
# see http://wiki.bitplan.com/index.php/Pymediawikidocker
#
FROM mediawiki:{{mwVersion}}

MAINTAINER Wolfgang Fahl <wf@bitplan.com>

# install some more utilities
RUN apt-get -y update && \
    apt-get -y --no-install-recommends --fix-missing install \
    mariadb-client \
    inetutils-ping \
    cron \
    curl \
    git \
    graphviz \
    imagemagick \
    procps \
    ssh-client \
    vim \
    unzip \
    libzip-dev \
    zip \
    && docker-php-ext-install zip \
    && rm -rf /var/lib/apt/lists/*

# plantuml
#  openssh-server \
#  dialog \
#  libjpeg62-turbo-dev \
#  libfreetype6-dev \
#  libpng-dev \
#  libzip-dev \
#  docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
#  docker-php-ext-install gd

# install composer
RUN curl -sS https://getcomposer.org/installer | php \
    && mv composer.phar /usr/local/bin/composer
    
# make sure to use version {{composerVersion}} of composer
# https://blog.packagist.com/deprecating-composer-1-support/
RUN composer self-update --{{composerVersion}}

# update mediawiki extensions via composer
COPY composer.local.json /var/www/html

RUN composer update --no-dev

# copy the LocalSettings
COPY LocalSettings.php /var/www/html

# COPY upload.ini
COPY upload.ini /usr/local/etc/php/conf.d

# copy phpinfo.php
COPY phpinfo.php /var/www/html

# copy the SQL dump
COPY wiki.sql /tmp

# copy the initdb.sh script
COPY initdb.sh /tmp

# copy the installExtensions.sh script
COPY installExtensions.sh /tmp

# copy the update.sh script
COPY update.sh /tmp

# copy the addSysopUser.sh script
COPY addSysopUser.sh /tmp

#copy the startRunJobs.sh script
COPY startRunJobs.sh /root

# copy the script to add a crontab entry
COPY addCronTabEntry.sh /root

# copy the plantuml script
COPY plantuml.sh /root

# make the scripts executable
RUN chmod +x /tmp/initdb.sh /tmp/update.sh /tmp/addSysopUser.sh /tmp/installExtensions.sh /root/addCronTabEntry.sh /root/startRunJobs.sh /root/plantuml.sh

# restore the mediawiki initial database backup
# can not do this before SQL server is up see https://docs.docker.com/compose/startup-order/
# RUN /tmp/initdb.sh