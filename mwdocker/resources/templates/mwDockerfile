#
# This dockerfile was generated by pymediawikidocker at {{timestamp}}
# see http://wiki.bitplan.com/index.php/Pymediawikidocker
#
FROM mediawiki:{{mwVersion}}

MAINTAINER Wolfgang Fahl <wf@bitplan.com>

# install some more utilities
RUN apt-get -y update && \
    apt-get -y --no-install-recommends --fix-missing install \
    mariadb-client \
    inetutils-ping \
    cron \
    curl \
    git \
    graphviz \
    imagemagick \
    procps \
    ssh-client \
    vim \
    unzip \
    libzip-dev \
    zip \
    && docker-php-ext-install zip \
    && rm -rf /var/lib/apt/lists/*

# plantuml
#  openssh-server \
#  dialog \
#  libjpeg62-turbo-dev \
#  libfreetype6-dev \
#  libpng-dev \
#  libzip-dev \
#  docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
#  docker-php-ext-install gd

# install composer
RUN curl -sS https://getcomposer.org/installer | php \
    && mv composer.phar /usr/local/bin/composer
    
# make sure to use version {{composerVersion}} of composer
# https://blog.packagist.com/deprecating-composer-1-support/
RUN composer self-update --{{composerVersion}}

# update mediawiki extensions via composer
COPY composer.local.json /var/www/html

RUN composer update --no-dev

# copy the LocalSettings
COPY LocalSettings.php /var/www/html

# COPY upload.ini
COPY upload.ini /usr/local/etc/php/conf.d

# copy phpinfo.php
COPY phpinfo.php /var/www/html

# copy the SQL dump
COPY wiki.sql /tmp

# copy the 
#    addCronTabEntry   - adds a crontab entry and starts the service
#    addSysopUser      - adds the sysop user to the mediawiki wiki sql database
#    fixPermissions    - fixes the /var/www/html permissions to www-data.www-data
#    initdb            - initializes the database
#    installExtensions - installs all extensions
#    lang              - script to add language icons
#    update            - runs maintainance update.php with parameters to ignore warnings        
#    startRunJobs      - start script for runjobs
# scripts
COPY addCronTabEntry.sh addSysopUser.sh fixPermissions.sh initdb.sh installExtensions.sh lang.sh plantuml.sh startRunJobs.sh update.sh   /root

# make the scripts executable
RUN chmod +x /root/addCronTabEntry.sh  /root/addSysopUser.sh /root/fixPermissions.sh /root/initdb.sh /root/installExtensions.sh /root/lang.sh /root/plantuml.sh /root/startRunJobs.sh /root/update.sh 

# restore the mediawiki initial database backup
# can not do this before SQL server is up see https://docs.docker.com/compose/startup-order/
# RUN /tmp/initdb.sh